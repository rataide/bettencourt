---
title: "COVID-19PT_RAM | `r format(Sys.time(),'%d %b %y-%H:%m')`"
knit: (function(input_file, encoding) {
  out_dir <- 'docs';
  rmarkdown::render(input_file,
 encoding=encoding,
 output_file=file.path(dirname(input_file), out_dir, 'index.html'))})
output: 
  flexdashboard::flex_dashboard:
    theme: lumen
    orientation: rows
#    vertical_layout: scroll
    social: [ "twitter", "facebook", "menu" ]
    navbar:
      - { title: "About", href: "https://github.com/aperaltasantos/covid_pt" }
---

<style>                     
.navbar {
  background-color:"#fdbe85";
  border-color:grey;
}
.navbar-brand {
color:black!important;
}
</style>  

```{r setup, include=FALSE}
library(flexdashboard)
```


```{r, include=FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  warning = FALSE,
  message = FALSE,
  echo = FALSE,
  eval = TRUE
  )
set.seed(1) # Set the seed is important for getting reproducible reports 
## Clean the envorment 
rm(list=ls())
options(scipen=4)
```




```{r echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
#library(tidyverse)
library(EpiEstim)
library(tidyr)
library(readr)
library(dplyr)
library(ggplot2)
library(forcats)
library(lubridate)
library(googlesheets)
require(RCurl)
library(viridis)
library(flexdashboard)
#library(epuRate)
library(here)
library(rjson)
library(jsonlite)
library(RCurl)
library(highcharter)
library(here)
#library(taskscheduleR)
#library(cronR)
#install.packages('miniUI')
#install.packages('shiny')
#install.packages("taskscheduleR")
```

```{r}
u <- "https://docs.google.com/spreadsheets/d/e/2PACX-1vRMXLHQCnR8qQZACsatuYflwGUH58okY8k-50-cnDDXLBXB4Jh7PImKXYzwHggYJsN374JeE-SvR0_W/pub?output=csv"
tc <- getURL(u, ssl.verifypeer=FALSE)
covid_pt <- read.csv(textConnection(tc))
```

```{r}
covid_pt$Data <- as.Date(covid_pt$Data,
                         "%d-%m-%Y"
                         )
covid_pt<-covid_pt  %>%
  mutate(week = week(Data)
  )
             
covid_pt <- mutate(covid_pt, 
                   Suspeitos_lag = lag(x = Suspeitos, 
                                        n = 1, 
                                        order_by = Data),
                   Suspeitos_var=Suspeitos-Suspeitos_lag,
                   Suspeitos_sign=if_else(Suspeitos_var>=0,"+","-"),
                   
                   Confirmados_lag = lag(x = Confirmados, 
                                        n = 1, 
                                        order_by = Data),
                   Confirmados_var=Confirmados-Confirmados_lag,
                   Confirmados_sign=if_else(Confirmados_var>=0,"+","-"),
                   
                   Internados_lag1 = lag(x = Internados, 
                                        n = 1, 
                                        order_by = Data),
                   Internados_var=Internados-Internados_lag1,
                   Internados_sign=if_else(Internados_var>=0,"+","-"),
                   
                    Intensivos_lag1 = lag(x = Intensivos, 
                                        n = 1, 
                                        order_by = Data),
                   Intensivos_var=Intensivos-Intensivos_lag1,
                   Intensivos_sign=if_else(Intensivos_var>=0,"+","-"),
                   
                   Recuperados_lag1 = lag(x = Recuperados, 
                                        n = 1, 
                                        order_by = Data),
                   Recuperados_var=Recuperados-Recuperados_lag1,
                   Recuperados_sign=if_else(Recuperados_var>=0,"+","-"),
                   
                   Mortes_lag1 = lag(x = Mortes, 
                                     n = 1, 
                                     order_by = Data),
                   Mortes_var=Mortes-Mortes_lag1,
                   Mortes_sign=if_else(Mortes_var>=0,"+","-"),
                   
                   AS_lag1 = lag(x = AS, 
                                        n = 1, 
                                        order_by = Data),
                   AS_var=AS-AS_lag1,
                   AS_sign=if_else(AS_var>=0,"+","-")
                   ) 
```

```{r}
covid_pt_english <- covid_pt %>%
  select(
    Data,
#    AS,
#    AS_var,
    Suspeitos,
    Suspeitos_var,
    Confirmados,
    Confirmados_var,
    Internados,
    Internados_var,
    Intensivos,
    Intensivos_var,
    Recuperados,
    Recuperados_var,
    Mortes,
    Mortes_var
  ) %>%
  rename(
    date="Data",
#    contact_tracing="AS",
#    contact_tracing_new="AS_var",
    lab_tested="Suspeitos",
    lab_tested_new="Suspeitos_var",
    confirmed="Confirmados",
    confirmed_new="Confirmados_var",
    inpatient="Internados",
    inpatient_new="Internados_var",
    recovered="Recuperados",
    recovered_new="Recuperados_var",
    ICU="Intensivos",
    ICU_new="Intensivos_var",
    death="Mortes",
    death_new="Mortes_var"
  ) 
write_csv(
  covid_pt_english,
  here::here(
    "datasets", 
     paste(
       format(Sys.time(), "%d_%b_%Y"),
       "covid_prt.csv")
  )
)
          
```


```{r}
covid_pt_l <- covid_pt %>%
  pivot_longer(
   cols = "Suspeitos":"AS",
   names_to = "tipo",
   values_to = "value",
   values_drop_na = TRUE
 ) 
covid_pt_last<-covid_pt %>% 
  filter(Data==last(Data))
```


Vig. Epidemiologica
=====================================  

Row
-----------------------------------------------------------------------

### Suspeitos
```{r}
x1 <- covid_pt_last$Suspeitos
x2<- covid_pt_last$Suspeitos_sign
x3<- abs(covid_pt_last$Suspeitos_var)
valueBox(paste(x1,"(",x2,x3,")"), 
         icon = "fa-exclamation-triangle",
         color="#fdd49e")
```

### Confirmados
```{r}
x1 <- covid_pt_last$Confirmados
x2<- covid_pt_last$Confirmados_sign
x3<- abs(covid_pt_last$Confirmados_var)
valueBox(paste(x1,"(",x2,x3,")"), 
         icon = "fa-file-medical",
         color="#fdbb84")
```

### Internados
```{r}
x1 <- covid_pt_last$Internados
x2<- covid_pt_last$Internados_sign
x3<- abs(covid_pt_last$Internados_var)
valueBox(paste(x1,"(",x2,x3,")"), 
         icon = "fa-hospital",
         color="#fc8d59")
```


Row
-----------------------------------------------------------------------

### Intensivos
```{r}
x1 <- covid_pt_last$Intensivos
x2<- covid_pt_last$Intensivos_sign
x3<- abs(covid_pt_last$Intensivos_var)
valueBox(paste(x1,"(",x2,x3,")"), 
         icon = "fas fa-procedures",
         color="#ef6548")
```

### Recuperados
```{r}
x1 <- covid_pt_last$Recuperados
x2<- covid_pt_last$Recuperados_sign
x3<- abs(covid_pt_last$Recuperados_var)
valueBox(paste(x1,"(",x2,x3,")"), 
         icon = "fas fa-walking",
         color="#a1d99b")
```

### ??bitos
```{r}
x1 <- covid_pt_last$Mortes
x2<- covid_pt_last$Mortes_sign
x3<- abs(covid_pt_last$Mortes_var)
valueBox(paste(x1,"(",x2,x3,")"), 
         icon = "fa-infinity",
         color="#bdbdbd")
```

Row {.tabset .tabset-fade}
-----------------------------------------------------------------------

```{r}
covid_pt1<- covid_pt %>%
  filter(
    Data>as.Date("2020-03-01")
  )
```


### Confirmados  

```{r}
highchart() %>% 
  hc_chart(type = "column") %>% 
  hc_add_theme(hc_theme_smpl()) %>% 
  hc_title(text = "Casos confirmados de COVID-19 na Regi??o Aut??noma da Madeira") %>% 
  hc_subtitle(text = "Fonte: IASA??DE & Autores") %>% 
  hc_xAxis(categories = format(covid_pt1$Data, "%b %d")) %>% 
  hc_yAxis(title = list(text = "Casos confirmados (cumulativo)")) %>% 
  hc_add_series(data = covid_pt1$Confirmados,
                name = "Confirmados", color = "#e6550d") %>% 
  hc_exporting(
    enabled = TRUE
  )
```

### Novos casos  

```{r}
highchart() %>% 
  hc_chart(type = "column" , color = "#e6550d") %>% 
  hc_add_theme(hc_theme_smpl()) %>% 
  hc_title(text = "Curva epid??mica de COVID-19 na Regi??o Aut??noma da Madeira") %>% 
  hc_subtitle(text = "Fonte: IASA??DE & Autores") %>% 
  hc_xAxis(categories = format(covid_pt1$Data, "%b %d")) %>% 
  hc_yAxis(title = list(text = "Novos casos confirmados")) %>% 
  hc_add_series(data = covid_pt1$Confirmados_var,
                name = "Novos casos", color = "#e6550d") %>% 
  hc_exporting(
    enabled = TRUE
  )
```

```{r}
u <- "https://docs.google.com/spreadsheets/d/e/2PACX-1vQJm8oY12efrr4DFOPkc7gscFRc-10_xcEniSU64nF2vwkDJNPF2w0xcitSXezst5LXi3FCn1HCcIqG/pub?gid=1697035743&single=true&output=csv"
tc <- getURL(u, ssl.verifypeer=FALSE)
map_pt_cases <- read.csv(textConnection(tc))
```


### Recuperados

```{r}
covid_pt2<- covid_pt %>%
  filter(
    Data>as.Date("2020-03-10")
  )
highchart() %>% 
  hc_chart(type = "column") %>% 
  hc_add_theme(hc_theme_smpl()) %>% 
  hc_title(text = "Casos recuperados de COVID-19 na Regi??o Aut??noma da Madeira") %>% 
  hc_subtitle(text = "Fonte: IASA??DE & Autores") %>% 
  hc_xAxis(categories = format(covid_pt2$Data, "%b %d")) %>% 
  hc_yAxis(title = list(text = "Casos recuperados (cumulativo)")) %>% 
  hc_add_series(data = covid_pt2$Recuperados,
                name = "Recuperados", color = "#a1d99b") %>% 
  hc_exporting(
    enabled = TRUE
  )
```

### Suspeitos

```{r}
highchart() %>% 
  hc_chart(type = "column") %>% 
  hc_add_theme(hc_theme_smpl()) %>% 
  hc_title(text = "Casos suspeitos de COVID-19 na Regi??o Aut??noma da Madeira") %>% 
  hc_subtitle(text = "Fonte: IASA??DE & Autores") %>% 
  hc_xAxis(categories = format(covid_pt$Data, "%b %d")) %>% 
  hc_yAxis(title = list(text = "Casos suspeitos (cumulativo)")) %>% 
  hc_add_series(data = covid_pt$Suspeitos,
                name = "Suspeitos", color = "#fd8d3c") %>% 
  hc_exporting(
    enabled = TRUE
  )
```




